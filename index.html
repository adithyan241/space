<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Moon Phase Calendar</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        @keyframes pulse-slow {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }
        .animate-pulse-slow {
            animation: pulse-slow 3s infinite ease-in-out;
        }
        @keyframes bounce-slow {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }
        .animate-bounce-slow {
            animation: bounce-slow 2s infinite ease-in-out;
        }
        /* Custom styles for hidden elements, initially hidden by default */
        .hidden-element {
            display: none;
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-indigo-900 to-purple-900 text-gray-100 p-4 sm:p-6 lg:p-8 flex flex-col items-center justify-center rounded-lg shadow-2xl">

    <h1 class="text-4xl sm:text-5xl lg:text-6xl font-extrabold mb-8 text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-purple-300 animate-pulse-slow text-center">
        Moon Phase Calendar ðŸŒ•
    </h1>

    <!-- Today's Moon Phase Section -->
    <section id="today-moon-phase-section" class="bg-white/10 backdrop-blur-sm p-6 sm:p-8 rounded-2xl shadow-xl border border-gray-700 w-full max-w-md lg:max-w-2xl mb-10 transform transition-all duration-500 hover:scale-105">
        <h2 class="text-2xl sm:text-3xl font-semibold mb-6 text-center text-blue-300">
            Today's Moon Phase
        </h2>
        <div id="today-moon-phase-content" class="flex flex-col items-center justify-center space-y-4">
            <p id="today-date" class="text-lg sm:text-xl font-medium text-gray-300"></p>
            <div class="relative flex items-center justify-center p-4 bg-gray-900/50 rounded-full shadow-inner">
                <div id="today-moon-icon"></div>
                <span class="absolute bottom-2 left-1/2 -translate-x-1/2 text-xs sm:text-sm font-bold text-teal-400 animate-bounce-slow">
                    Current
                </span>
            </div>
            <p id="today-moon-name" class="text-xl sm:text-2xl font-bold text-center text-purple-200"></p>
            <button id="generate-insight-btn"
                class="mt-4 px-6 py-2 bg-gradient-to-r from-yellow-500 to-orange-500 text-white font-bold rounded-full shadow-md hover:shadow-lg transform hover:scale-105 transition-all duration-300 focus:outline-none focus:ring-4 focus:ring-yellow-300 active:scale-95"
                disabled>
                Moon Phase Insight âœ¨
            </button>
            <p id="moon-phase-insight" class="mt-4 text-md text-center text-gray-200 bg-gray-800/60 p-4 rounded-lg italic border border-yellow-600 hidden-element"></p>
        </div>
        <p id="loading-today-phase" class="text-center text-gray-400">Loading moon phase...</p>
    </section>

    <!-- Next 7 Days Feature Button -->
    <button id="show-next-7-days-btn"
        class="px-8 py-3 bg-gradient-to-r from-green-500 to-blue-500 text-white font-bold text-lg rounded-full shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-300 focus:outline-none focus:ring-4 focus:ring-green-300 active:scale-95 mb-6">
        Show Next 7 Days ðŸ“…
    </button>

    <!-- Next 7 Days Moon Phases Section -->
    <section id="next-7-days-section" class="mt-10 bg-white/10 backdrop-blur-sm p-6 sm:p-8 rounded-2xl shadow-xl border border-gray-700 w-full max-w-md lg:max-w-4xl transform transition-all duration-500 hover:scale-[1.01] mb-10 hidden-element">
        <h2 class="text-2xl sm:text-3xl font-semibold mb-6 text-center text-blue-300">
            Next 7 Days Moon Phases
        </h2>
        <div id="next-7-days-grid" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 xl:grid-cols-4 gap-6">
            <!-- Moon phases for next 7 days will be injected here -->
        </div>
        <div class="flex justify-center mt-8">
            <button id="hide-next-7-days-btn"
                class="px-6 py-2 bg-gray-600 hover:bg-gray-700 text-white font-bold rounded-full shadow-md transform hover:scale-105 transition-all duration-300 focus:outline-none focus:ring-4 focus:ring-gray-400 active:scale-95">
                Hide ðŸ‘†
            </button>
        </div>
    </section>

    <!-- Moon Phase Story Section (LLM Feature) -->
    <section id="moon-phase-story-section" class="bg-white/10 backdrop-blur-sm p-6 sm:p-8 rounded-2xl shadow-xl border border-gray-700 w-full max-w-md lg:max-w-2xl mt-6 transform transition-all duration-500 hover:scale-105">
        <h2 class="text-2xl sm:text-3xl font-semibold mb-6 text-center text-pink-300">
            Moon Phase Story
        </h2>
        <div class="flex flex-col items-center justify-center space-y-4">
            <p class="text-lg sm:text-xl font-medium text-gray-300 text-center">
                Generate a short, enchanting story inspired by the current moon phase!
            </p>
            <button id="generate-story-btn"
                class="mt-4 px-6 py-2 bg-gradient-to-r from-purple-500 to-pink-500 text-white font-bold rounded-full shadow-md hover:shadow-lg transform hover:scale-105 transition-all duration-300 focus:outline-none focus:ring-4 focus:ring-purple-300 active:scale-95"
                disabled>
                Moon Phase Story âœ¨
            </button>
            <p id="moon-phase-story" class="mt-4 text-md text-center text-gray-200 bg-gray-800/60 p-4 rounded-lg italic border border-pink-600 hidden-element"></p>
        </div>
    </section>

    <script>
        // SVG icons for different moon phases (as string literals)
        const MoonPhaseIcons = {
            'new-moon': `<svg viewBox="0 0 100 100" class="w-24 h-24 lg:w-32 lg:h-32 text-gray-800 dark:text-gray-200"><circle cx="50" cy="50" r="40" fill="currentColor"/><circle cx="50" cy="50" r="40" fill="black"/></svg>`,
            'full-moon': `<svg viewBox="0 0 100 100" class="w-24 h-24 lg:w-32 lg:h-32 text-gray-800 dark:text-gray-200"><circle cx="50" cy="50" r="40" fill="currentColor"/></svg>`,
            'first-quarter': `<svg viewBox="0 0 100 100" class="w-24 h-24 lg:w-32 lg:h-32 text-gray-800 dark:text-gray-200"><circle cx="50" cy="50" r="40" fill="currentColor"/><path d="M50 10 A40 40 0 0 1 50 90 L50 10 Z" fill="black"/></svg>`,
            'last-quarter': `<svg viewBox="0 0 100 100" class="w-24 h-24 lg:w-32 lg:h-32 text-gray-800 dark:text-gray-200"><circle cx="50" cy="50" r="40" fill="currentColor"/><path d="M50 10 A40 40 0 0 0 50 90 L50 10 Z" fill="black"/></svg>`,
            'waxing-crescent': `<svg viewBox="0 0 100 100" class="w-24 h-24 lg:w-32 lg:h-32 text-gray-800 dark:text-gray-200"><circle cx="50" cy="50" r="40" fill="currentColor"/><path d="M65 15 A40 40 0 0 1 65 85 Q35 50 65 15 Z" fill="black"/></svg>`,
            'waning-crescent': `<svg viewBox="0 0 100 100" class="w-24 h-24 lg:w-32 lg:h-32 text-gray-800 dark:text-gray-200"><circle cx="50" cy="50" r="40" fill="currentColor"/><path d="M35 15 A40 40 0 0 0 35 85 Q65 50 35 15 Z" fill="black"/></svg>`,
            'waxing-gibbous': `<svg viewBox="0 0 100 100" class="w-24 h-24 lg:w-32 lg:h-32 text-gray-800 dark:text-gray-200"><circle cx="50" cy="50" r="40" fill="currentColor"/><path d="M30 18 A40 40 0 0 0 30 82 Q60 50 30 18 Z" fill="black"/></svg>`,
            'waning-gibbous': `<svg viewBox="0 0 100 100" class="w-24 h-24 lg:w-32 lg:h-32 text-gray-800 dark:text-gray-200"><circle cx="50" cy="50" r="40" fill="currentColor"/><path d="M70 18 A40 40 0 0 1 70 82 Q40 50 70 18 Z" fill="black"/></svg>`,
        };

        // Global variable to store today's moon phase name for LLM calls
        let currentMoonPhaseName = '';

        /**
         * Function to calculate the moon phase for a given date.
         * Uses a simplified algorithm based on the days since a known new moon epoch.
         * @param {Date} date - The date for which to calculate the moon phase.
         * @returns {{name: string, icon: string}} An object containing the moon phase name and its corresponding icon key.
         */
        const getMoonPhase = (date) => {
            // New Moon on January 6, 2000, 18:14 UTC (Epoch)
            const epoch = new Date("2000-01-06T18:14:00Z");
            // Average length of a synodic month (lunar cycle)
            const synodicMonth = 29.530588;

            // Calculate the difference in milliseconds between the given date and the epoch
            const diffMillis = date.getTime() - epoch.getTime();
            // Convert milliseconds to days
            let diffDays = diffMillis / (1000 * 60 * 60 * 24);

            // Calculate the phase within the current synodic month
            let phase = diffDays % synodicMonth;
            // Ensure the phase is positive
            const phaseAge = phase < 0 ? phase + synodicMonth : phase;

            // Determine the moon phase name and icon based on the phase age
            if (phaseAge < 1.84566) return { name: "New Moon", icon: "new-moon" };
            if (phaseAge < 5.53699) return { name: "Waxing Crescent", icon: "waxing-crescent" };
            if (phaseAge < 9.22831) return { name: "First Quarter", icon: "first-quarter" };
            if (phaseAge < 12.91963) return { name: "Waxing Gibbous", icon: "waxing-gibbous" };
            if (phaseAge < 16.61096) return { name: "Full Moon", icon: "full-moon" };
            if (phaseAge < 20.30228) return { name: "Waning Gibbous", icon: "waning-gibbous" };
            if (phaseAge < 23.99361) return { name: "Last Quarter", icon: "last-quarter" };
            if (phaseAge < 27.68493) return { name: "Waning Crescent", icon: "waning-crescent" };
            return { name: "New Moon", icon: "new-moon" }; // Falls back to New Moon for the end of the cycle
        };

        /**
         * Helper function to format dates.
         * @param {Date} date - The date object to format.
         * @returns {string} The formatted date string (e.g., "Mon, Aug 26").
         */
        const formatDate = (date) => {
            return new Intl.DateTimeFormat('en-US', {
                weekday: 'short',
                month: 'short',
                day: 'numeric',
            }).format(date);
        };

        /**
         * Makes an API call to Gemini with exponential backoff.
         * @param {string} prompt - The text prompt for the LLM.
         * @param {number} retries - Current retry count.
         * @param {number} delay - Current delay for exponential backoff.
         * @returns {Promise<string>} The generated text from the LLM.
         */
        const callGeminiApiWithBackoff = async (prompt, retries = 0, delay = 1000) => {
            const maxRetries = 5; // Maximum number of retries
            const apiKey = ""; // API key will be provided by Canvas runtime if empty
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            let chatHistory = [];
            chatHistory.push({ role: "user", parts: [{ text: prompt }] });
            const payload = { contents: chatHistory };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    // If response is not OK, it might be a rate limit or server error
                    if (response.status === 429 && retries < maxRetries) { // Too Many Requests
                        await new Promise(res => setTimeout(res, delay));
                        return callGeminiApiWithBackoff(prompt, retries + 1, delay * 2); // Exponential backoff
                    }
                    throw new Error(`API error: ${response.status} ${response.statusText}`);
                }

                const result = await response.json();
                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    return result.candidates[0].content.parts[0].text;
                } else {
                    throw new Error('Unexpected API response structure or no content.');
                }
            } catch (error) {
                console.error('Error in Gemini API call:', error);
                throw error; // Re-throw to be handled by the calling function
            }
        };


        /**
         * Updates the display for today's moon phase.
         */
        const updateTodayMoonPhase = () => {
            const today = new Date();
            const phase = getMoonPhase(today);
            currentMoonPhaseName = phase.name; // Store for LLM calls

            document.getElementById('loading-today-phase').classList.add('hidden-element');
            document.getElementById('today-moon-phase-content').classList.remove('hidden-element');

            document.getElementById('today-date').textContent = formatDate(today);
            document.getElementById('today-moon-icon').innerHTML = MoonPhaseIcons[phase.icon];
            document.getElementById('today-moon-name').textContent = phase.name;

            // Enable LLM buttons once moon phase is loaded
            document.getElementById('generate-insight-btn').disabled = false;
            document.getElementById('generate-story-btn').disabled = false;
        };

        /**
         * Handles the click event for generating moon phase insight.
         */
        const handleGenerateInsight = async () => {
            const insightBtn = document.getElementById('generate-insight-btn');
            const insightText = document.getElementById('moon-phase-insight');

            insightBtn.disabled = true;
            insightBtn.textContent = 'Generating...';
            insightText.textContent = ''; // Clear previous insight
            insightText.classList.add('hidden-element'); // Hide until content is ready

            const prompt = `Give me a fun fact or a piece of interesting folklore about the "${currentMoonPhaseName}" moon phase. Keep it concise, around 2-3 sentences.`;

            try {
                const text = await callGeminiApiWithBackoff(prompt);
                insightText.textContent = text;
                insightText.classList.remove('hidden-element');
            } catch (error) {
                insightText.textContent = 'Could not generate insight. Please try again.';
                insightText.classList.remove('hidden-element');
            } finally {
                insightBtn.disabled = false;
                insightBtn.textContent = 'Moon Phase Insight âœ¨';
            }
        };

        /**
         * Handles the click event for generating a moon phase story.
         */
        const handleGenerateStory = async () => {
            const storyBtn = document.getElementById('generate-story-btn');
            const storyText = document.getElementById('moon-phase-story');

            storyBtn.disabled = true;
            storyBtn.textContent = 'Weaving Tale...';
            storyText.textContent = ''; // Clear previous story
            storyText.classList.add('hidden-element'); // Hide until content is ready

            const prompt = `Write a very short, imaginative story (around 4-5 sentences) inspired by the "${currentMoonPhaseName}" moon phase. Focus on wonder and mystery.`;

            try {
                const text = await callGeminiApiWithBackoff(prompt);
                storyText.textContent = text;
                storyText.classList.remove('hidden-element');
            } catch (error) {
                storyText.textContent = 'Could not generate story. Please try again.';
                storyText.classList.remove('hidden-element');
            } finally {
                storyBtn.disabled = false;
                storyBtn.textContent = 'Moon Phase Story âœ¨';
            }
        };

        /**
         * Handles the click event for showing the next 7 days' moon phases.
         */
        const handleShowNext7Days = () => {
            const next7DaysSection = document.getElementById('next-7-days-section');
            const next7DaysGrid = document.getElementById('next-7-days-grid');
            const showBtn = document.getElementById('show-next-7-days-btn');

            next7DaysGrid.innerHTML = ''; // Clear previous content

            for (let i = 0; i < 7; i++) {
                const date = new Date();
                date.setDate(date.getDate() + i + 1); // Get next day, next + 1, etc.
                const phase = getMoonPhase(date);

                const phaseDiv = document.createElement('div');
                phaseDiv.className = "flex flex-col items-center justify-center p-4 bg-gray-800/70 rounded-xl shadow-md transform hover:scale-105 transition-all duration-300 border border-gray-700";
                phaseDiv.innerHTML = `
                    <p class="text-md sm:text-lg font-medium text-gray-300 mb-2">${formatDate(date)}</p>
                    ${MoonPhaseIcons[phase.icon]}
                    <p class="text-md sm:text-xl font-bold text-center text-purple-200 mt-2">
                        ${phase.name}
                    </p>
                `;
                next7DaysGrid.appendChild(phaseDiv);
            }

            next7DaysSection.classList.remove('hidden-element');
            showBtn.classList.add('hidden-element');
        };

        /**
         * Handles the click event for hiding the next 7 days' moon phases.
         */
        const handleHideNext7Days = () => {
            const next7DaysSection = document.getElementById('next-7-days-section');
            const showBtn = document.getElementById('show-next-7-days-btn');

            next7DaysSection.classList.add('hidden-element');
            showBtn.classList.remove('hidden-element');
        };

        // Attach event listeners when the DOM is fully loaded
        document.addEventListener('DOMContentLoaded', () => {
            updateTodayMoonPhase();
            document.getElementById('show-next-7-days-btn').addEventListener('click', handleShowNext7Days);
            document.getElementById('hide-next-7-days-btn').addEventListener('click', handleHideNext7Days);
            document.getElementById('generate-insight-btn').addEventListener('click', handleGenerateInsight);
            document.getElementById('generate-story-btn').addEventListener('click', handleGenerateStory);
        });
    </script>
</body>
</html>
